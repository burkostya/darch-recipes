version: v1.0
name: dev
agent:
  machine:
    type: e1-standard-8
    os_image: ubuntu1804

blocks:
  - name: dev
    task:
      prologue:
        commands:
          - sudo apt-get install -y libseccomp-dev curl gnupg software-properties-common
          - wget -O- -q https://github.com/containerd/containerd/releases/download/v1.2.0/containerd-1.2.0.linux-amd64.tar.gz | sudo tar xpz -C /
          - sudo wget https://github.com/opencontainers/runc/releases/download/v1.0.0-rc5/runc.amd64 -O /bin/runc && sudo chmod +x /bin/runc
          - curl -s https://raw.githubusercontent.com/godarch/darch/develop/scripts/install | sudo DARCH_TAG=v0.26.4 bash /dev/stdin
          - sudo mkdir -p /etc/containerd
          - echo 'disabled_plugins = ["cri"]' | sudo tee /etc/containerd/config.toml
          - sudo containerd &
          - sleep 5
          - darch version
          - sudo ctr version
          - sudo runc --version
          - sudo chmod a+rwX -R /tmp
          - checkout
          - cd ./thinkpad
      jobs:
        - name: dev
          commands:
            - RECIPE=dev retry -t 3 -s 10 ./ci
      secrets:
        - name: docker-login

promotions:
  - name: perf
    pipeline_file: 04-perf.yml
    auto_promote_on:
    - result: passed