version: v1.0
name: Archlinux
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804

blocks:
  - name: base
    task:
      prologue: &prologue
        commands:
          - sudo apt-get install -y libseccomp-dev curl gnupg software-properties-common
          - wget -O- -q https://github.com/containerd/containerd/releases/download/v1.2.0/containerd-1.2.0.linux-amd64.tar.gz | sudo tar xpz -C /
          - sudo wget https://github.com/opencontainers/runc/releases/download/v1.0.0-rc5/runc.amd64 -O /bin/runc && sudo chmod +x /bin/runc
          - curl -s https://raw.githubusercontent.com/godarch/darch/develop/scripts/install | sudo DARCH_TAG=v0.26.4 bash /dev/stdin
          - sudo mkdir -p /etc/containerd
          - echo 'disabled_plugins = ["cri"]' | sudo tee /etc/containerd/config.toml
          - sudo containerd &
          - sleep 5
          - darch version
          - sudo ctr version
          - sudo runc --version
          - sudo chmod a+rwX -R /tmp
      jobs:
        - name: base
          commands:
            - checkout
            - cd ./thinkpad && RECIPE=base retry -t 3 -s 10 ./ci
      secrets:
        - name: docker-login
  - name: user
    task:
      prologue: *prologue
      jobs:
        - name: user
          commands:
            - checkout
            - cd ./thinkpad && RECIPE=user retry -t 3 -s 10 ./ci
      secrets:
        - name: docker-login
  - name: sec
    task:
      prologue: *prologue
      jobs:
        - name: sec
          commands:
            - checkout
            - cd ./thinkpad && RECIPE=sec retry -t 3 -s 10 ./ci
      secrets:
        - name: docker-login
  - name: dev
    task:
      prologue: *prologue
      jobs:
        - name: dev
          commands:
            - checkout
            - cd ./thinkpad && RECIPE=dev retry -t 3 -s 10 ./ci
      secrets:
        - name: docker-login
  - name: x
    task:
      prologue: *prologue
      jobs:
        - name: x
          commands:
            - checkout
            - cd ./thinkpad && RECIPE=x retry -t 3 -s 10 ./ci
      secrets:
        - name: docker-login
  - name: audio
    task:
      prologue: *prologue
      jobs:
        - name: audio
          commands:
            - checkout
            - cd ./thinkpad && RECIPE=audio retry -t 3 -s 10 ./ci
      secrets:
        - name: docker-login
  - name: i3
    task:
      prologue: *prologue
      jobs:
        - name: i3
          commands:
            - checkout
            - cd ./thinkpad && RECIPE=i3 retry -t 3 -s 10 ./ci
      secrets:
        - name: docker-login
  - name: browser
    task:
      prologue: *prologue
      jobs:
        - name: browser
          commands:
            - checkout
            - cd ./thinkpad && RECIPE=browser retry -t 3 -s 10 ./ci
      secrets:
        - name: docker-login
  - name: terminal
    task:
      prologue: *prologue
      jobs:
        - name: terminal
          commands:
            - checkout
            - cd ./thinkpad && RECIPE=terminal retry -t 3 -s 10 ./ci
      secrets:
        - name: docker-login
  - name: social
    task:
      prologue: *prologue
      jobs:
        - name: social
          commands:
            - checkout
            - cd ./thinkpad && RECIPE=social retry -t 3 -s 10 ./ci
      secrets:
        - name: docker-login
  - name: design
    task:
      prologue: *prologue
      jobs:
        - name: design
          commands:
            - checkout
            - cd ./thinkpad && RECIPE=design retry -t 3 -s 10 ./ci
        - name: games
          commands:
            - checkout
            - cd ./thinkpad && RECIPE=games retry -t 3 -s 10 ./ci
      secrets:
        - name: docker-login