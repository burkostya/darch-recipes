#!/bin/bash
set -e

pacman -S --noconfirm ttf-dejavu otf-fira-code

pacman -S --noconfirm docker docker-compose docker-machine
# systemctl enable docker
usermod -aG docker burkostya
# alternative stack for containers
pacman -S --noconfirm shadow buildah skopeo podman
# enable rootless mode for containers
echo "session    optional   pam_cgfs.so          -c freezer,memory,name=systemd,unified" >> /etc/pam.d/system-login
echo "burkostya:100000:65536" >> /etc/subuid
setcap cap_setuid+ep /usr/bin/newuidmap
echo "burkostya:100000:65536" >> /etc/subgid
setcap cap_setgid+ep /usr/bin/newgidmap

pacman -S --noconfirm libx264

function install_aur () {
    local package="$1"

    echo "==> installing $package"

    local deps="$(trizen -Qi visual-studio-code-bin | grep "Depends On" | cut -d: -f2)"

    pacman -S --noconfirm --needed $deps
    runuser -l burkostya -c "trizen -G $package"
    runuser -l burkostya -c "cd $package && makepkg -s --noconfirm"
    pacman -U --noconfirm --needed /home/burkostya/$package/$(ls /home/burkostya/$package/ | grep tar.xz)
}

install_aur "visual-studio-code-bin"
# pacman -S --noconfirm --needed libnotify lsof
# runuser -l burkostya -c "trizen -G visual-studio-code-bin"
# runuser -l burkostya -c "cd visual-studio-code-bin && makepkg -s --noconfirm"
# pacman -U --noconfirm --needed /home/burkostya/visual-studio-code-bin/$(ls /home/burkostya/visual-studio-code-bin/ | grep tar.xz)

runuser -l burkostya -c "cat $(pwd)/vscode-extensions | xargs -n 1 code --install-extension"

trizen -S --noconfirm --noedit postman-bin

trizen -S --noconfirm --noedit tldr

pacman -S --noconfirm jq

trizen -S --noconfirm --noedit --needed python-xmltodict python-toml
trizen -S --noconfirm --noedit --needed yq pup-bin

pacman -S --noconfirm go

pacman -S --noconfirm linux-headers
pacman -S --noconfirm virtualbox virtualbox-host-modules-arch
# trizen -S --noconfirm --noedit virtualbox-ext-oracle
systemctl enable systemd-modules-load
usermod -aG vboxusers burkostya

# Fonts
# trizen -S --noconfirm --noedit nerd-fonts-complete

pacman -S --noconfirm --needed vim

pacman -S --noconfirm --needed dbeaver
pacman -S --noconfirm --needed dbeaver-plugin-office dbeaver-plugin-svg-format

# trizen -S --noconfirm --noedit sos xsos

echo -en "y\nn" | trizen -Scc

pacman -S --noconfirm --needed syncthing syncthing-gtk

trizen -S --noconfirm --noedit --needed alloy tla-toolbox

echo -en "y\nn" | trizen -Scc